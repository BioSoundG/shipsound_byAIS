# テスト仕様書

このディレクトリには、`shipsound_byAIS` プロジェクトのテストコードが含まれています。テストは Python の標準ライブラリ `unittest` を使用しています。

## テスト実行方法

プロジェクトのルートディレクトリから以下のコマンドを実行してすべてのテストを実行します：

```bash
python -m unittest discover -s test
```

特定のテストファイルのみを実行する場合：

```bash
python -m unittest test.test_audio_processing
```

## テストファイル一覧

### test_audio_processing.py

このテストファイルは `audio_processing.py` のテストを含み、WAV ファイルのカット機能とメタデータ生成機能をテストします。

#### 主なテストケース：

1. **test_cut_wav_file**  
   WAV ファイルを適切に切り出し、適切なメタデータを生成できることを確認します。

2. **test_cut_source_start_time_calculation**  
   母ファイル内での切り出し開始位置の計算が正確であることを検証します。異なる時間位置とオフセットに対して複数のケースをテストします。

3. **test_cut_wav_and_make_metadata_isolated**  
   メタデータ生成機能を分離してテストします。実際のファイル操作をモックして、メタデータの書き込みと内容を検証します。

4. **test_second_wav_file_cut**  
   連結された WAV ファイルの 2 つ目のファイルから正確に切り出しができることを確認します。

5. **test_max_distance_cutoff**  
   最大距離の閾値に基づいてカットするかどうかを判断する機能をテストします。設定した距離よりも遠い船舶のカットがスキップされることを検証します。

6. **test_check_other_vessels_condition**  
   ある時点で対象船舶が最も近い船舶である場合にのみカットする機能をテストします。他の船舶が対象船舶よりも近い場合にはカットされないことを確認します。

## テスト環境

テストでは以下のような一時的なデータを作成して使用します：

- テスト用の WAV ファイル（シンウェーブで作成）
- テスト用のメタデータ構造
- テスト用の船舶距離データ（DataFrame 形式）

各テストの実行前に一時的なテストディレクトリが作成され、テスト後に削除されます。

## モックとスタブ

いくつかのテストでは以下の手法を使用しています：

- 実際のファイル I/O 操作をモックして、テストを高速化
- トレーサブルな結果を確保するためのスタブの使用
- 結果の検証用にモック関数内での関数呼び出しの追跡

## テスト追加ガイドライン

新機能や変更を追加する際は、以下の点に注意してテストを追加または更新してください：

1. 新しい条件や機能には専用のテストケースを追加する
2. エッジケースをテストする（例：ファイル境界をまたぐケース、極端な時間値など）
3. テストでは実際のファイルシステムへの依存を最小限に抑える
4. 可能な限りモックを使用して独立したユニットテストを作成する
5. テスト結果が決定論的であること（実行ごとに同じ結果が得られる）を確保する 