# shipsound_byAIS プロジェクト概要

## プロジェクトの目的

このプロジェクトは、AIS（船舶自動識別システム）データとWAVオーディオファイルを組み合わせて処理し、船舶の音響特性を分析するためのツールです。主な目的は以下の通りです：

1. 船舶のAISデータから船舶の軌跡と録音地点との距離を計算する
2. 船舶が録音地点に最も接近した時間を中心に音声ファイルを切り出す
3. 切り出された音声に対応するメタデータを生成する
4. 船舶の軌跡や音声スペクトログラムの可視化を行う

## プロジェクト構造

```
.
├── audio_processing.py       # 音声処理：WAVファイルの切り出しとメタデータ生成
├── data_processing.py        # データ処理：AISデータの読み込みと軌跡補間
├── distance_calculation.py   # 距離計算：船舶と録音位置間の距離計算
├── visualization.py          # 可視化：地理的プロットとスペクトログラム生成
├── main.py                   # メイン実行スクリプト
├── config.toml               # 設定ファイル：各種パラメータとフラグ
├── metadata.toml             # メタデータテンプレート
├── requirements.txt          # 依存ライブラリ一覧
├── test/                     # テストディレクトリ
│   ├── test_audio_processing.py  # 音声処理のテスト
│   ├── README.md                 # テスト仕様書
│   └── test_output/              # テスト出力ディレクトリ（自動生成）
├── ais_example/              # サンプルAISデータ
├── wav_example/              # サンプルWAVファイル
└── README.md                 # プロジェクト英語ドキュメント
```

## 主な機能

### データ処理（data_processing.py）
- AISデータの読み込みと前処理
- タイムスタンプの変換と船舶軌跡の補間
- 不完全なデータの補完

### 距離計算（distance_calculation.py）
- ハバーサイン公式を用いた船舶と録音位置間の距離計算
- 各船舶が録音位置に最も接近した時刻と距離の特定

### 音声処理（audio_processing.py）
- 船舶接近時のWAVファイル切り出し
- 切り出し条件の制御
  - 最大距離制限：設定した距離より遠い船舶はスキップ
  - 他船比較：対象船舶が最も近い船舶である場合のみ切り出し
  - 時間マージン：最接近時刻の前後の指定時間を切り出し
- 切り出したファイルに関するメタデータ生成（TOML形式）

### 可視化（visualization.py）
- 船舶の軌跡と録音位置の地理的可視化
- 元の音声ファイルの時間平均スペクトログラムの生成
- 切り出し区間のマーキング

## 使用方法

以下のコマンドでプログラムを実行します：

```bash
python main.py -a AISデータフォルダ -w WAVファイルフォルダ -m メタデータTOMLファイル -t 録音開始時間 [-c 設定ファイル] [-ff] [-cf]
```

### 主なコマンドライン引数
- `-a`, `--ais_path`：AISデータが含まれるフォルダへのパス（必須）
- `-w`, `--wav_path`：WAVファイルが含まれるフォルダへのパス（必須）
- `-m`, `--toml_path`：観測情報が含まれるTOMLメタデータファイルへのパス（必須）
- `-t`, `--record_start_time`：録音開始時間（ISO形式、例：'2024-03-19T06:53:00'）（必須）
- `-c`, `--config_path`：設定TOMLファイルへのパス（省略可、デフォルト：'config.toml'）
- `-ff`, `--fig_flag`：可視化図（地理的プロットとスペクトログラム）を生成するフラグ
- `-cf`, `--csv_flag`：距離計算結果をCSVファイルとして保存するフラグ

### 設定ファイル

`config.toml`ファイルには以下のセクションがあります：

#### 音声処理パラメータ
```toml
[audio_processing]
# 最短距離時刻の前後の時間マージン（分）
cut_margin_minutes = 5

# WAV切り出しの最大距離閾値（メートル）
# この距離より遠い船舶はスキップされます
max_cut_distance = 10000.0

# 最短距離時に最も近い船舶かどうかをチェック
# trueの場合、最短距離時に最も近い船舶の場合のみ切り出し
check_other_vessels = true
```

#### 可視化設定
```toml
[visualization]
# 時間平均スペクトログラムのパラメータ
chunk_duration_seconds = 300  # 処理チャンクの時間（秒）
spectrogram_nperseg = 1024    # STFTのセグメント長

# プロット外観
plot_max_freq_bins = 200      # 表示する最大周波数ビン
plot_db_min = -80             # カラーマップの最小dBレベル
plot_db_max = -10             # カラーマップの最大dBレベル
plot_max_cuts = 15            # 表示する切り出し注釈の最大数
plot_dpi = 150                # 画像保存のDPI
```

## 主な出力

1. **切り出しWAVファイル**：船舶接近時の音声ファイル
2. **メタデータファイル**：各切り出しファイルに対応するTOMLメタデータ
3. **地理的可視化**：船舶の軌跡と録音位置を示す図
4. **スペクトログラム**：時間平均スペクトログラムと切り出し区間の表示
5. **距離データCSV**：計算された距離情報（オプション）

## 特記事項

- 長時間の録音ファイルでもメモリ効率良く処理するための時間平均化技術を使用
- 複数のWAVファイルを連結して処理可能
- ファイル間の境界をまたいだ切り出しにも対応
- 船舶AISデータが時間的に疎な場合でも適切に補間処理

## テスト

テストは`unittest`フレームワークを使用して実装されており、以下のコマンドで実行できます：

```bash
python -m unittest discover -s test
```

特に音声処理機能については、次のテストがあります：
- WAVファイル切り出し機能のテスト
- 母ファイル内での切り出し開始位置計算のテスト
- メタデータ生成機能のテスト
- 複数WAVファイルからの切り出しテスト
- 最大距離制限機能のテスト
- 他船舶比較機能のテスト 